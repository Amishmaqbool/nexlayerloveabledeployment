name: Deploy to NextLayer

on:
  push:
    branches:
      - main
  workflow_dispatch: # Allows manual triggering

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build project
        run: npm run build

      - name: Deploy to NextLayer
        id: deploy
        env:
          NEXLAYER_MCP_TOKEN: ${{ secrets.NEXLAYER_MCP_TOKEN }}
          GITHUB_REPO: ${{ github.repository }}
          GITHUB_REF: ${{ github.ref }}
        run: |
          echo "ğŸš€ Deploying to NextLayer..."
          
          # Extract branch name from ref (e.g., refs/heads/main -> main)
          BRANCH_NAME=$(echo "$GITHUB_REF" | sed 's/refs\/heads\///')
          
          # Prepare deployment payload
          DEPLOY_PAYLOAD=$(cat <<EOF
          {
            "repo": "https://github.com/$GITHUB_REPO",
            "branch": "$BRANCH_NAME",
            "commit": "${{ github.sha }}",
            "build_output": "dist"
          }
          EOF
          )
          
          # Deploy to NextLayer
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST https://mcp.nexlayer.ai/api/mcp \
            -H "Authorization: Bearer $NEXLAYER_MCP_TOKEN" \
            -H "Content-Type: application/json" \
            -d "$DEPLOY_PAYLOAD")
          
          # Extract HTTP status code and body
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')
          
          echo "Response HTTP Code: $HTTP_CODE"
          echo "Response Body: $BODY"
          
          # Try to extract deployment URL from response
          if [ "$HTTP_CODE" -eq 200 ] || [ "$HTTP_CODE" -eq 201 ]; then
            # Try multiple ways to extract URL from JSON response
            DEPLOYMENT_URL=$(echo "$BODY" | grep -oE '"url":"[^"]*"' | head -1 | cut -d'"' -f4 || \
                            echo "$BODY" | grep -oE '"deployment_url":"[^"]*"' | head -1 | cut -d'"' -f4 || \
                            echo "$BODY" | grep -oE '"deploymentUrl":"[^"]*"' | head -1 | cut -d'"' -f4 || \
                            echo "$BODY" | grep -oE 'https?://[^"]*\.nexlayer\.ai[^"]*' | head -1 || \
                            echo "")
            
            if [ -n "$DEPLOYMENT_URL" ]; then
              echo "âœ… Deployment successful!"
              echo "ğŸŒ Deployment URL: $DEPLOYMENT_URL"
              echo "deployment_url=$DEPLOYMENT_URL" >> $GITHUB_OUTPUT
              echo "DEPLOYMENT_URL=$DEPLOYMENT_URL" >> $GITHUB_ENV
              
              # Store deployment URL in a file for easy retrieval
              echo "$DEPLOYMENT_URL" > deployment-url.txt
              echo "$DEPLOYMENT_URL" | tee deployment-url.txt
            else
              echo "âš ï¸ Deployment successful but URL not found in response"
              echo "Response: $BODY"
              echo "ğŸ’¡ Check NextLayer dashboard for deployment URL"
            fi
          else
            echo "âŒ Deployment failed with HTTP code: $HTTP_CODE"
            echo "Response: $BODY"
            exit 1
          fi

      - name: Store deployment URL as artifact
        if: steps.deploy.outputs.deployment_url != ''
        uses: actions/upload-artifact@v4
        with:
          name: deployment-url
          path: deployment-url.txt
          retention-days: 90

      - name: Store deployment URL in repository variable (via API)
        if: steps.deploy.outputs.deployment_url != '' && secrets.GITHUB_TOKEN != ''
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          DEPLOYMENT_URL: ${{ steps.deploy.outputs.deployment_url }}
        run: |
          # Store as repository variable for easy access
          # Note: This requires repo admin permissions
          curl -X PUT \
            -H "Authorization: token $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/${{ github.repository }}/actions/variables/NEXLAYER_DEPLOYMENT_URL" \
            -d "{\"value\":\"$DEPLOYMENT_URL\"}" || echo "âš ï¸ Could not store as repository variable (may require admin permissions)"

      - name: Create deployment summary
        if: steps.deploy.outputs.deployment_url != ''
        run: |
          echo "## ğŸš€ NextLayer Deployment" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Deployment successful!**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ğŸŒ **Live URL:** [${{ steps.deploy.outputs.deployment_url }}](${{ steps.deploy.outputs.deployment_url }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY

      - name: Comment deployment URL on commit (if PR)
        if: github.event_name == 'pull_request' && steps.deploy.outputs.deployment_url != ''
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `ğŸš€ **NextLayer Deployment Complete!**\n\nğŸŒ **Live URL:** ${{ steps.deploy.outputs.deployment_url }}\n\nThis deployment was triggered automatically from commit ${{ github.sha }}`
            })

      - name: Output deployment URL
        if: steps.deploy.outputs.deployment_url != ''
        run: |
          echo "=========================================="
          echo "ğŸ‰ NextLayer Deployment Complete!"
          echo "=========================================="
          echo ""
          echo "ğŸŒ Your app is live at:"
          echo "${{ steps.deploy.outputs.deployment_url }}"
          echo ""
          echo "=========================================="

